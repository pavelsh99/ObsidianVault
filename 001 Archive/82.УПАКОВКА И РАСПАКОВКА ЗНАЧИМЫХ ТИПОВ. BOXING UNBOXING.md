---
tags:
  - csharp
  - ООП
  - вопрос_на_собеседовании
date: 2026-02-19
---
[Упаковка и распаковка значимых типов c# | boxing and unboxing | C# ОТ НОВИЧКА К ПРОФЕССИОНАЛУ | # 82](https://www.youtube.com/watch?v=FawYy8tztdI&list=PLQOaTSbfxUtD6kMmAYc8Fooqya3pjLs1N&index=103)
# Что такое `boxing` и `unboxing`

> Эти операции позволяют упаковать и распаковать значимые типы (которые хранятся в стеке) в управляемую кучу.

> Это тема  - вопрос на собеседовании.
> `boxing` и `unboxing` влияют на производительность, при этом обычно они происходят неявно:

```csharp
            int a  = 1; // Value type
            object b = a;// boxing
            int c = (int)b;//unboxing
```

- `int a` это структура, и хранится в стеке
- `object b` - это класс, и он хранится в управляемой куче
- когда мы записываем в класс `object b` структуру `int a`, происходит `boxing`
- Мы выделяем место в управляемой куче, копируем туда данные из переменной `a`
- Получаем ссылку в управляемой куче на эти данные

- Когда мы "явно присваиваем" `object b` тип `int`, то есть структуру происходит `unboxing`
- Операция "явного присваивания" на самом деле распаковка
# Почему распаковка и упаковка плохо влияет на производительность?

1.	Выделение памяти — значение копируется из стека (stack) на кучу (heap), требуя выделения памяти
2.	Сборка мусора — объекты на куче требуют управления сборщиком мусора. При этом при работе сборщика мусора, работа программы приостанавливается.
3.	Дополнительное копирование — данные копируются при упаковке и распаковке
4.	Cache misses — работа с кучей медленнее, чем со стеком

Результат бенчмарка кода с упаковкой и без:
![[Pasted image 20260219121447.png]]

# Как проверить, есть ли операции упаковки и распаковки без `benchmark`?

Можно посмотреть il-код, в который компилируется  c# с помощью утилиты `ILSPY`
![[Pasted image 20260219122724.png]]

Для этого нужно предварительно пересобрать решение:
![[Pasted image 20260219122800.png]]

Переключаем язык:
![[Pasted image 20260219122907.png]]

Видим ключевые слова распаковки и упаковки:
![[Pasted image 20260219122946.png]]

## Существует огромное количество примеров, когда при работе со структурами неявно происходит распаковка и упаковка.

# Вывод:
Всегда нужно стремиться избегать этих ситуаций по максимуму.
